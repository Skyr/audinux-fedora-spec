From 2c1d64c2b12bb083945583077c16d61bfecb652a Mon Sep 17 00:00:00 2001
From: Yann Collette <ycollette.nospam@free.fr>
Date: Wed, 28 Dec 2022 22:40:00 +0100
Subject: [PATCH] aarch64

---
 arch.mk               | 2 +-
 compile.mk            | 5 ++++-
 dep.mk                | 3 +++
 src/common.cpp        | 3 +++
 src/engine/Engine.cpp | 7 ++++---
 5 files changed, 15 insertions(+), 5 deletions(-)

diff --git a/arch.mk b/arch.mk
index a2a75a3..348a9b2 100644
--- a/arch.mk
+++ b/arch.mk
@@ -11,7 +11,7 @@ else ifneq (,$(findstring arm64-,$(MACHINE)))
 	ARCH_ARM64 := 1
 	ARCH_CPU := arm64
 else ifneq (,$(findstring aarch64-,$(MACHINE)))
-	ARCH_ARM64 := 1
+	ARCH_AARCH64 := 1
 	ARCH_CPU := arm64
 else
 $(error Could not determine CPU architecture of $(MACHINE))
diff --git a/compile.mk b/compile.mk
index 011b436..8a7343a 100644
--- a/compile.mk
+++ b/compile.mk
@@ -35,6 +35,9 @@ ifdef ARCH_ARM64
 	FLAGS += -DARCH_ARM64
 	FLAGS += -march=armv8-a+fp+simd
 endif
+ifdef ARCH_AARCH64
+	FLAGS += -DARCH_AARCH64
+endif
 
 ifdef ARCH_LIN
 	FLAGS += -DARCH_LIN
@@ -97,7 +100,7 @@ build/%.m.o: %.m
 build/%.bin.o: %
 	@mkdir -p $(@D)
 ifdef ARCH_LIN
-	$(OBJCOPY) -I binary -O elf64-x86-64 -B i386:x86-64 --rename-section .data=.rodata,alloc,load,readonly,data,contents $< $@
+	$(OBJCOPY) -I binary -O elf64-littleaarch64 -B aarch64 --rename-section .data=.rodata,alloc,load,readonly,data,contents $< $@
 endif
 ifdef ARCH_WIN
 	$(OBJCOPY) -I binary -O pe-x86-64 -B i386:x86-64 --rename-section .data=.rodata,alloc,load,readonly,data,contents $< $@
diff --git a/dep.mk b/dep.mk
index 41fe589..21d3c25 100644
--- a/dep.mk
+++ b/dep.mk
@@ -22,6 +22,9 @@ endif
 ifdef ARCH_ARM64
 	DEP_FLAGS += -march=armv8-a+fp+simd
 endif
+ifdef ARCH_AARCH64
+	DEP_FLAGS += 
+endif
 
 ifdef ARCH_MAC
 	DEP_MAC_SDK_FLAGS := -mmacosx-version-min=10.9
diff --git a/src/common.cpp b/src/common.cpp
index 4f2869c..1d865a1 100644
--- a/src/common.cpp
+++ b/src/common.cpp
@@ -36,6 +36,9 @@ const std::string APP_VERSION = TOSTRING(_APP_VERSION);
 #elif defined ARCH_ARM64
 	const std::string APP_CPU = "arm64";
 	const std::string APP_CPU_NAME = "ARM64";
+#elif defined ARCH_AARCH64
+	const std::string APP_CPU = "aarch64";
+	const std::string APP_CPU_NAME = "AARCH64";
 #endif
 const std::string API_URL = "https://api.vcvrack.com";
 
diff --git a/src/engine/Engine.cpp b/src/engine/Engine.cpp
index 453a4a0..cc8bd1d 100644
--- a/src/engine/Engine.cpp
+++ b/src/engine/Engine.cpp
@@ -5,9 +5,10 @@
 #include <mutex>
 #include <atomic>
 #include <tuple>
-#if defined ARCH_X64
-	#include <pmmintrin.h>
-#endif
+#define SIMDE_ENABLE_NATIVE_ALIASES
+#include <simde/x86/sse3.h>
+#include <simde/x86/sse2.h>
+#include <simde/x86/sse.h> 
 
 #include <engine/Engine.hpp>
 #include <settings.hpp>
-- 
2.38.1

